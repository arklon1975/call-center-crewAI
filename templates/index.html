<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Call Center System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-headset me-2"></i>
                Multi-Agent Call Center
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/dashboard">Dashboard</a>
                {% if user %}
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-user me-1"></i>{{ user.full_name or user.username }}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="changePassword()"><i class="fas fa-key me-2"></i>Cambiar Contraseña</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión</a></li>
                    </ul>
                </div>
                {% else %}
                <a class="nav-link" href="/login">Login</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-8">
                <!-- Call Initiation Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-phone-alt me-2"></i>Initiate New Call</h5>
                    </div>
                    <div class="card-body">
                        <form id="initiateCallForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="customerPhone" class="form-label">Customer Phone</label>
                                    <input type="tel" class="form-control" id="customerPhone" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="customerName" class="form-label">Customer Name</label>
                                    <input type="text" class="form-control" id="customerName">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="initialMessage" class="form-label">Initial Message</label>
                                <textarea class="form-control" id="initialMessage" rows="3" placeholder="Customer's initial inquiry..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-phone me-2"></i>Start Call
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Active Call Interface -->
                <div id="activeCallSection" class="card mb-4" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-phone me-2"></i>Active Call: <span id="activeCallId"></span></h5>
                        <div>
                            <span class="badge bg-info me-2" id="callDuration">00:00</span>
                            <button class="btn btn-danger btn-sm" id="endCallBtn">
                                <i class="fas fa-phone-slash me-1"></i>End Call
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Call Information -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <strong>Customer:</strong> <span id="callCustomerInfo"></span>
                            </div>
                            <div class="col-md-4">
                                <strong>Department:</strong> <span id="callDepartment"></span>
                            </div>
                            <div class="col-md-4">
                                <strong>Agent:</strong> <span id="currentAgent"></span>
                            </div>
                        </div>

                        <!-- Conversation History -->
                        <div class="conversation-container mb-3">
                            <div id="conversationHistory" class="conversation-history"></div>
                        </div>

                        <!-- Message Input -->
                        <form id="customerMessageForm">
                            <div class="input-group">
                                <input type="text" class="form-control" id="customerMessage" placeholder="Type customer message..." required>
                                <button class="btn btn-primary" type="submit">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <!-- System Status -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6><i class="fas fa-heartbeat me-2"></i>System Status</h6>
                    </div>
                    <div class="card-body">
                        <div id="systemStatus">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>System Health:</span>
                                <span class="badge bg-success" id="healthStatus">Checking...</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Active Calls:</span>
                                <span class="badge bg-info" id="activeCallsCount">0</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Available Agents:</span>
                                <span class="badge bg-success" id="availableAgentsCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Agent Status -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6><i class="fas fa-users me-2"></i>Agent Status</h6>
                    </div>
                    <div class="card-body">
                        <div id="agentsList">
                            <div class="text-center text-muted">Loading agents...</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="/dashboard" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-chart-bar me-2"></i>View Dashboard
                            </a>
                            <button class="btn btn-outline-info btn-sm" id="refreshStatusBtn">
                                <i class="fas fa-sync-alt me-2"></i>Refresh Status
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Alerts -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
        <div id="alertContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentCallId = null;
        let callTimer = null;
        let callStartTime = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadSystemStatus();
            loadAgentStatus();
            
            // Set up periodic updates
            setInterval(loadSystemStatus, 30000); // Update every 30 seconds
            setInterval(loadAgentStatus, 30000);
        });

        // Form event listeners
        document.getElementById('initiateCallForm').addEventListener('submit', handleInitiateCall);
        document.getElementById('customerMessageForm').addEventListener('submit', handleCustomerMessage);
        document.getElementById('endCallBtn').addEventListener('click', handleEndCall);
        document.getElementById('refreshStatusBtn').addEventListener('click', function() {
            loadSystemStatus();
            loadAgentStatus();
        });

        async function handleInitiateCall(e) {
            e.preventDefault();
            
            const customerPhone = document.getElementById('customerPhone').value;
            const customerName = document.getElementById('customerName').value;
            const initialMessage = document.getElementById('initialMessage').value;

            try {
                const response = await fetch('/api/calls/initiate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customer_phone: customerPhone,
                        customer_name: customerName,
                        initial_message: initialMessage
                    })
                });

                const data = await response.json();

                if (data.success) {
                    currentCallId = data.call_id;
                    showActiveCall(data);
                    showAlert('Call initiated successfully!', 'success');
                    
                    // Display initial response if available
                    if (data.initial_response && data.initial_response.response) {
                        displayMessage('agent', data.initial_response.response, data.initial_response.agent_id);
                    }
                } else {
                    showAlert('Failed to initiate call: ' + (data.error || 'Unknown error'), 'danger');
                }
            } catch (error) {
                showAlert('Error initiating call: ' + error.message, 'danger');
            }
        }

        async function handleCustomerMessage(e) {
            e.preventDefault();
            
            if (!currentCallId) return;

            const message = document.getElementById('customerMessage').value;
            if (!message.trim()) return;

            // Display customer message
            displayMessage('customer', message);
            document.getElementById('customerMessage').value = '';

            try {
                const response = await fetch('/api/calls/message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        call_id: currentCallId,
                        message: message
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Display agent response
                    displayMessage('agent', data.response, data.agent_id);
                    
                    // Update current agent if changed
                    if (data.agent_id) {
                        document.getElementById('currentAgent').textContent = data.agent_id;
                    }
                    
                    // Show escalation info if applicable
                    if (data.escalation_required && data.escalation_info) {
                        showAlert('Call escalated to supervisor', 'warning');
                    }
                } else {
                    showAlert('Failed to process message: ' + (data.error || 'Unknown error'), 'danger');
                }
            } catch (error) {
                showAlert('Error sending message: ' + error.message, 'danger');
            }
        }

        async function handleEndCall() {
            if (!currentCallId) return;

            try {
                const response = await fetch('/api/calls/end', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        call_id: currentCallId,
                        resolution_status: 'completed'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    hideActiveCall();
                    showAlert(`Call ended successfully! Duration: ${formatDuration(data.duration_seconds)}`, 'success');
                    loadSystemStatus(); // Refresh system status
                } else {
                    showAlert('Failed to end call: ' + (data.error || 'Unknown error'), 'danger');
                }
            } catch (error) {
                showAlert('Error ending call: ' + error.message, 'danger');
            }
        }

        function showActiveCall(callData) {
            document.getElementById('activeCallSection').style.display = 'block';
            document.getElementById('activeCallId').textContent = callData.call_id;
            
            // Set call information
            const customerInfo = callData.customer_name ? 
                `${callData.customer_name} (${callData.customer_phone})` : 
                callData.customer_phone;
            document.getElementById('callCustomerInfo').textContent = customerInfo;
            
            if (callData.routing_info && callData.routing_info.routing_decision) {
                document.getElementById('callDepartment').textContent = 
                    callData.routing_info.routing_decision.department_name || 'General';
                document.getElementById('currentAgent').textContent = 'Customer Service Agent';
            }

            // Clear conversation history
            document.getElementById('conversationHistory').innerHTML = '';

            // Start call timer
            callStartTime = new Date();
            startCallTimer();
        }

        function hideActiveCall() {
            document.getElementById('activeCallSection').style.display = 'none';
            currentCallId = null;
            
            // Stop timer
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            // Reset form
            document.getElementById('initiateCallForm').reset();
        }

        function displayMessage(type, content, agentId = null) {
            const conversationHistory = document.getElementById('conversationHistory');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message mb-2`;
            
            const timestamp = new Date().toLocaleTimeString();
            const sender = type === 'customer' ? 'Customer' : (agentId || 'Agent');
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <strong>${sender}</strong>
                    <small class="text-muted">${timestamp}</small>
                </div>
                <div class="message-content">${content}</div>
            `;
            
            conversationHistory.appendChild(messageDiv);
            conversationHistory.scrollTop = conversationHistory.scrollHeight;
        }

        function startCallTimer() {
            callTimer = setInterval(() => {
                if (callStartTime) {
                    const elapsed = Math.floor((new Date() - callStartTime) / 1000);
                    document.getElementById('callDuration').textContent = formatDuration(elapsed);
                }
            }, 1000);
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/system/health');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('healthStatus').textContent = data.status;
                    document.getElementById('healthStatus').className = 
                        `badge ${data.status === 'healthy' ? 'bg-success' : 'bg-warning'}`;
                }

                // Load dashboard summary for call counts
                const summaryResponse = await fetch('/api/dashboard/summary');
                const summaryData = await summaryResponse.json();

                if (summaryData.success) {
                    document.getElementById('activeCallsCount').textContent = 
                        summaryData.active_calls.total_active_calls || 0;
                    document.getElementById('availableAgentsCount').textContent = 
                        summaryData.available_agents || 0;
                }
            } catch (error) {
                document.getElementById('healthStatus').textContent = 'Error';
                document.getElementById('healthStatus').className = 'badge bg-danger';
            }
        }

        async function loadAgentStatus() {
            try {
                const response = await fetch('/api/dashboard/agents');
                const data = await response.json();

                if (data.success) {
                    const agentsList = document.getElementById('agentsList');
                    agentsList.innerHTML = '';

                    data.agents.forEach(agent => {
                        const agentDiv = document.createElement('div');
                        agentDiv.className = 'agent-status mb-2 p-2 border rounded';
                        
                        const statusBadge = agent.status === 'available' ? 'bg-success' : 
                                          agent.status === 'busy' ? 'bg-warning' : 'bg-secondary';
                        
                        agentDiv.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${agent.name}</strong>
                                    <small class="text-muted d-block">${agent.role}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge ${statusBadge}">${agent.status}</span>
                                    <small class="d-block text-muted">${agent.current_calls} active</small>
                                </div>
                            </div>
                        `;
                        agentsList.appendChild(agentDiv);
                    });
                }
            } catch (error) {
                document.getElementById('agentsList').innerHTML = 
                    '<div class="text-center text-danger">Error loading agents</div>';
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alertDiv);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Logout function
        async function logout() {
            if (!confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                return;
            }

            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert('Sesión cerrada exitosamente', 'success');
                    // Redirect to login page after a short delay
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1000);
                } else {
                    showAlert('Error al cerrar sesión: ' + (data.detail || 'Error desconocido'), 'danger');
                }
            } catch (error) {
                console.error('Logout error:', error);
                showAlert('Error al cerrar sesión. Redirigiendo...', 'warning');
                // Redirect anyway in case of network error
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            }
        }

        // Change password function
        function changePassword() {
            // Create modal for password change
            const modalHtml = `
                <div class="modal fade" id="changePasswordModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Cambiar Contraseña</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="changePasswordForm">
                                    <div class="mb-3">
                                        <label for="currentPassword" class="form-label">Contraseña Actual</label>
                                        <input type="password" class="form-control" id="currentPassword" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="newPassword" class="form-label">Nueva Contraseña</label>
                                        <input type="password" class="form-control" id="newPassword" required>
                                        <div class="form-text">Mínimo 8 caracteres, debe incluir mayúsculas, minúsculas, números y símbolos.</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="confirmPassword" class="form-label">Confirmar Nueva Contraseña</label>
                                        <input type="password" class="form-control" id="confirmPassword" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" onclick="submitPasswordChange()">Cambiar Contraseña</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('changePasswordModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
            modal.show();
        }

        // Submit password change
        async function submitPasswordChange() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                showAlert('Todos los campos son requeridos', 'warning');
                return;
            }

            if (newPassword !== confirmPassword) {
                showAlert('Las nuevas contraseñas no coinciden', 'warning');
                return;
            }

            if (newPassword.length < 8) {
                showAlert('La nueva contraseña debe tener al menos 8 caracteres', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert('Contraseña cambiada exitosamente', 'success');
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                    modal.hide();
                    // Clear form
                    document.getElementById('changePasswordForm').reset();
                } else {
                    showAlert('Error al cambiar contraseña: ' + (data.detail || 'Error desconocido'), 'danger');
                }
            } catch (error) {
                console.error('Password change error:', error);
                showAlert('Error al cambiar contraseña', 'danger');
            }
        }
    </script>
</body>
</html>
